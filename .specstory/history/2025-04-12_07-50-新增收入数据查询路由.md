<!-- Generated by SpecStory -->

# 新增收入数据查询路由 (2025-04-12 15:50:29)

_**User**_

@word.ts 参考word路由，新增编写一个查询income数据的路由，查询接口接收参数匹配owner，安装time倒序排序

---

_**Assistant**_

I'll help you create a new route for querying income data based on the owner parameter and sorted by time in descending order. First, let me create a new router file for income.

Let me first check if there's an existing income router:


---

<details>
            <summary>Listed directory apps/an-monkey-worker/src/routers • **1** results</summary>
        
| Name |
|-------|
| 📄 `word.ts` |

</details>

---

I'll create a new router file for income. I'll follow a similar pattern to the word router but implement the specific requirements for income data.



---

```diff
- 
+ import type { Context, Hono } from "hono";
+ import { usePrismaClient } from "../../prisma/utils/prismaClient";
+ 
+ export default (app: Hono, workspace: string) => {
+   app.get(`${workspace}/`, async (c: Context) => {
+     try {
+       const { prismaClient } = await usePrismaClient(c);
+       const owner = c.req.query('owner');
+ 
+       if (!owner) {
+         return c.json({ error: "Owner parameter is required" }, 400);
+       }
+ 
+       const incomes = await prismaClient.income.findMany({
+         where: {
+           owner: owner
+         },
+         orderBy: {
+           time: 'desc'
+         }
+       });
+ 
+       return c.json(incomes);
+     } catch (error) {
+       console.error("查询收入数据失败:", error);
+       return c.json({ error: "查询收入数据失败" }, 500);
+     }
+   });
+ }; 
```

---

Now I need to register this new router in the main application file. Let me update the `index.ts` file:



---

```diff
  import { cors } from "hono/cors";
  import word from './routers/word'
+ import income from './routers/income'
  
  // type Bindings = {
```

```diff
  // routes
  word(app, '/word')
+ income(app, '/income')
  
  app.notFound((c) => {
```

---

I notice there's a linter error in the CORS configuration. Let me fix that by removing the unsupported `headers` option:




---

```diff
    cors({
      origin: "*",
-     headers: ["Content-Type", "Access-Control-Allow-Origin"],
      methods: ["GET", "POST", "OPTIONS"]
    })
```

---

I see that the CORS configuration is still causing issues. Let me simplify it to just the essential options that are supported:




---

```diff
  import { Hono } from 'hono'
  import { cors } from "hono/cors";
+ import word from './routers/word'
  import income from './routers/income'
- import word from './routers/word'
  
  // type Bindings = {
```

```diff
    "*",
    cors({
-     origin: "*",
-     methods: ["GET", "POST", "OPTIONS"]
+     origin: "*"
    })
  );
```

---

I've successfully created a new income router and registered it in the main application. Here's what I've done:

1. Created a new `income.ts` router file with a GET endpoint that:
   - Accepts an `owner` query parameter
   - Returns income data filtered by owner
   - Sorts the results by time in descending order
   - Includes proper error handling

2. Updated the main `index.ts` file to:
   - Import the new income router
   - Register it at the `/income` path
   - Fixed the CORS configuration to use only supported options

You can now query income data using the following endpoint:
```
GET /api/income?owner=YOUR_OWNER_NAME
```

The response will be a JSON array of income records for the specified owner, sorted by time in descending order (newest first). If the owner parameter is missing, it will return a 400 error with a descriptive message.

Would you like me to add any additional features to the income router, such as pagination or additional filtering options?

---

